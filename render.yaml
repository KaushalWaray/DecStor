# This file configures the deployment of your services on Render.
# You can learn more at https://render.com/docs/yaml-spec

services:
  # This is the Next.js frontend
  - type: web
    name: decstor-frontend
    env: nextjs
    plan: free # Can be changed to a paid instance

# OPTIONAL: Example Persistent Disk guidance
# Render's YAML spec typically requires creating disks in the Render UI and
# attaching them to services. Below is a commented, example block showing the
# intent and a recommended mount point and startCommand (already wired above).
# Keep this block as documentation for reviewers and to copy/paste into the
# Render UI or to use as a reference when creating a disk resource.
    repo: https://github.com/KaushalWaray/DecStor
    branch: main # Or your default branch
    buildCommand: 'npm install && npm run build'
    startCommand: 'npm start'
    envVars:
      - key: NEXT_PUBLIC_BACKEND_URL
        # This will automatically use the URL of the backend service defined below
        fromService:
          type: web
          name: decstor-backend
          property: url
      - key: NODE_ENV
        value: production

  # This is the Express.js backend
  - type: web
    name: decstor-backend
    env: node

    plan: free # Can be changed to a paid instance
    repo: https://github.com/KaushalWaray/DecStor
    branch: main # Or your default branch
    # Tell Render to look for the backend code in the 'backend' directory
    rootDir: backend
    buildCommand: 'npm install && npm run build'
    # Use a startup wrapper that symlinks a mounted persistent disk (if present)
    # into ./orbitdb so OrbitDB data can persist across deploys when a disk
    # is attached at the mount path /disk. If no disk is attached the command
    # still runs and the server will start using ephemeral storage.
    startCommand: "sh -lc \"mkdir -p /disk/orbitdb && rm -rf ./orbitdb && ln -s /disk/orbitdb ./orbitdb || true && npm start\""
    healthCheckPath: /api # Check if the backend is alive
    envVars:
      - key: SERVICE_WALLET_MNEMONIC
        sync: false # Set this in the Render dashboard
      - key: PINATA_JWT
        sync: false # Set this in the Render dashboard
      - key: NODE_ENV
        value: production
